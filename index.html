<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Электронная очередь</title>

  <!-- анти-кеш -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Jura:wght@300;400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />

  <style>
:root {
  --color-bg: #0d0f1a;
  --color-panel-bg: #141829;
  --color-border: #2a3150;
  --color-text: #d0d8ff;
  --color-text-label: #8a99c2;
  --color-primary: #4a90e2;
  --color-secondary: #50e3c2;
  --color-error: #e24a4a;
  --font-primary: 'Jura', sans-serif;
  --font-secondary: 'Orbitron', sans-serif;
  --shadow-glow-primary: 0 0 8px rgba(74,144,226,.6);
  --shadow-glow-secondary: 0 0 8px rgba(80,227,194,.6);
  --shadow-glow-error: 0 0 8px rgba(226,74,74,.6);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
  width: 100%; min-height: 100vh; font-family: var(--font-primary);
  background-color: var(--color-bg); color: var(--color-text);
  font-size: 16px; font-weight: 400; overflow-x: hidden;
  background: repeating-linear-gradient(var(--color-bg) 0 2px, #0f1220 2px 3px);
}
h2 {
  font-family: var(--font-secondary); font-weight: 700; font-size: 1.5rem;
  color: var(--color-primary); text-shadow: 0 0 10px rgba(74,144,226,.4);
  text-transform: uppercase;
}
.container {
  display: flex; flex-wrap: wrap; width: 100%; max-width: 1400px;
  margin: 2rem auto; padding: 1rem; gap: 2rem; flex-flow: wrap-reverse
}
/* оверлей */
.closed-overlay {
  position: fixed; inset: 0; display: none;
  align-items: center; justify-content: center; text-align: center;
  background: linear-gradient(180deg, rgba(13,15,26,.95), rgba(13,15,26,.95));
  z-index: 9999; padding: 2rem; border-top: 2px solid var(--color-border);
}
.closed-overlay.active { display: flex; }
.closed-card {
  background: var(--color-panel-bg);
  border: 1px dashed var(--color-border);
  border-radius: 12px; padding: 2rem 2.5rem; max-width: 720px;
  box-shadow: 0 10px 30px rgba(0,0,0,.5);
}
.closed-title {
  font-family: var(--font-secondary);
  font-size: 1.6rem; margin-bottom: .75rem; color: var(--color-secondary);
  text-shadow: 0 0 8px rgba(80,227,194,.35);
}
.closed-text { color: var(--color-text-label); line-height: 1.6; }
.closed-emoji { font-size: 2.2rem; margin-bottom: .5rem; display: block; max-width: 40%; margin: 0 auto; }
.closed-schedule { margin-top: 1rem; font-family: monospace; opacity: .85; }

/* остальной стиль */
.queue-panel { flex: 1; min-width: 300px; }
.form-panel { flex: 1; min-width: 300px; max-width: 500px; }
.queue-panel, .form-panel > div {
  background-color: var(--color-panel-bg); border: 1px solid var(--color-border);
  border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,.4);
  display: flex; flex-direction: column;
}
.panel-header {
  padding: 1.5rem; border-bottom: 1px solid var(--color-border);
  display: flex; justify-content: space между; align-items: center;
}
.queue-list-container {
  padding: 1rem 0; flex-grow: 1; position: relative;
  min-height: 400px; overflow-y: auto;
}
#queue-list { list-style: none; }
#queue-list li {
  display: flex; align-items: center; justify-content: space-between;
  gap: 1rem; padding: 1rem 1.5rem; border-bottom: 1px solid var(--color-border);
  font-size: 1.1rem; font-weight: 300; animation: fadeIn .5s ease-out;
}
#queue-list li:last-child { border-bottom: none; }
#queue-list li .queue-number {
  font-family: var(--font-secondary); font-size: 1.25rem; font-weight: 700;
  color: var(--color-primary); min-width: 50px;
  text-shadow: 0 0 5px rgba(74,144,226,.5);
}
#queue-list li .queue-name { word-break: break-all; flex-grow: 1; }
#queue-list li .queue-time {
  font-size: .9rem; color: var(--color-text-label);
  font-family: monospace; white-space: nowrap;
}
.empty-message {
  text-align: center; position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%); color: var(--color-text-label);
}
.empty-message span { font-size: 2rem; font-family: monospace; }
.empty-message.hidden { display: none; }
#form-container { padding-bottom: 1.5rem; }
#talon-form { padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; }
#talon-form p { font-size: .9rem; color: var(--color-text-label); line-height: 1.5; }
.input-group { display: flex; flex-direction: column; gap: .5rem; }
.input-group label {
  font-size: .8rem; font-weight: 700; color: var(--color-text-label);
  text-transform: uppercase; letter-spacing: 1px;
}
input[type="text"] {
  background-color: var(--color-bg); border: 1px solid var(--color-border);
  border-radius: 4px; padding: .75rem 1rem; font-family: var(--font-primary);
  font-size: 1.1rem; color: var(--color-text); outline: none; transition: all .2s ease;
}
input[type="text"]:focus { border-color: var(--color-primary); box-shadow: var(--shadow-glow-primary); }
button {
  font-family: var(--font-secondary); font-size: 1rem; font-weight: 700;
  color: #fff; background-color: var(--color-primary); border: none;
  border-radius: 4px; padding: .8rem 1.5rem; cursor: pointer;
  text-transform: uppercase; letter-spacing: 1px; transition: all .3s ease;
  box-shadow: 0 0 10px rgba(74,144,226,.5); position: relative; overflow: hidden;
}
button:hover:not(:disabled) { background-color: #5aa1f2; box-shadow: 0 0 15px rgba(74,144,226,.8); }
button:disabled { background-color: var(--color-text-label); box-shadow: none; cursor: not-allowed; }
button .button-text { transition: opacity .2s ease; }
button:disabled .button-text { opacity: 0; }
.error-message { color: var(--color-error); text-shadow: 0 0 5px var(--color-error); font-size: .9rem; text-align: center; display: none; }
.hidden { display: none !important; }
#talon-container { padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; animation: fadeIn .5s ease; }
.talon {
  border: 1px solid var(--color-primary); border-radius: 8px;
  background: linear-gradient(145deg, var(--color-panel-bg), #1a203d);
  box-shadow: var(--shadow-glow-primary); overflow: hidden; position: relative;
}
.talon::before {
  content: ''; position: absolute; top: -1px; right: -1px; width: 40px; height: 40px;
  background: linear-gradient(135deg, transparent 50%, var(--color-secondary) 50%);
  box-shadow: var(--shadow-glow-secondary);
}
.talon-header { display: flex; align-items: center; gap: .5rem; padding: 1rem 1.5rem; background-color: rgba(42,49,80,.5); border-bottom: 1px dashed var(--color-primary); }
.talon-chip { width: 24px; height: 18px; background-color: var(--color-secondary); border: 1px solid var(--color-border); border-radius: 3px; }
.talon-title { font-family: var(--font-secondary); color: var(--color-secondary); text-shadow: var(--shadow-glow-secondary); font-size: 1.2rem; }
.talon-body { padding: 2rem 1.5rem; display: grid; grid-template-columns: auto 1fr; gap: .5rem 1rem; align-items: center; }
.talon-label { font-size: .9rem; color: var(--color-text-label); text-transform: uppercase; }
#talon-name { font-size: 1.2rem; font-weight: 700; color: var(--color-text); }
#talon-number { grid-column: 1 / -1; text-align: center; }
.talon-number-large {
  font-family: var(--font-secondary); font-size: 4rem; font-weight: 700;
  color: var(--color-primary); text-shadow: 0 0 12px rgba(74,144,226,.7); padding: 1rem 0;
}
.talon-footer { padding: .5rem 1.5rem; font-family: monospace; font-size: .75rem; color: var(--color-text-label); background-color: rgba(13,15,26,.5); text-align: center; }
.button-secondary { background: transparent; border: 1px solid var(--color-text-label); color: var(--color-text-label); box-shadow: none; }
.button-secondary:hover:not(:disabled) { background: var(--color-text-label); color: var(--color-bg); box-shadow: 0 0 10px var(--color-text-label); }
.button-danger { border-color: var(--color-error); color: var(--color-error); }
.button-danger:hover:not(:disabled) { background: var(--color-error); color: var(--color-bg); box-shadow: var(--shadow-glow-error); }
.loader-container { width: 24px; height: 24px; display: none; }
.loader-container.active { display: block; }
#submit-button .loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; }
button:disabled .loader { display: block; }
.loader { width: 20px; height: 20px; border: 3px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; }
#submit-button .loader { border-top-color: var(--color-bg); width: 24px; height: 24px; }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>

  <!-- бут-стиль: до schedule.json всё закрыто -->
  <style id="boot-style">
    .container { display: none !important; }
    #closed-overlay { display: flex !important; }
  </style>

  <script>
    // глобальные флаги
    window.__SITE_OPEN__   = false;  // реально открыт?
    window.__BLOCK_INIT__  = true;   // блокировать инициализацию приложения
    window.__APP_STARTED__ = false;  // стартовали ли Firebase-приложение
  </script>
</head>
<body>

  <!-- оверлей -->
  <div id="closed-overlay" class="closed-overlay">
    <div class="closed-card">
      <img src="https://pogorelovyd.github.io/2Kyrs/23cb8205a648bba2e5b8f8311ffb15dc.png" class="closed-emoji" alt="">
      <div class="closed-title">Сейчас не время :)</div>
      <div class="closed-text">
        Этот сервис доступен только на паре.<br>Загляните, пожалуйста, на пару.
      </div>
      <div class="closed-schedule" id="closed-schedule"></div>
      <div id="reopen-countdown"></div>
    </div>
  </div>

  <main class="container" style="display:none">
    <section class="queue-panel">
      <header class="panel-header">
        <h2>ТЕКУЩАЯ ОЧЕРЕДЬ</h2>
        <div class="loader-container" id="queue-loader"><div class="loader"></div></div>
      </header>
      <div class="queue-list-container">
        <ul id="queue-list"></ul>
        <div id="empty-queue-message" class="empty-message">
          <span>(¬_¬)</span>
          <p>Очередь пуста.<br>Будь первым.</p>
        </div>
      </div>
    </section>

    <section class="form-panel">
      <div id="form-container">
        <header class="panel-header"><h2>ПОЛУЧИТЬ ТАЛОН</h2></header>
        <form id="talon-form">
          <p>Введите ваше имя для регистрации в очереди.</p>
          <div class="input-group">
            <label for="name-input">ВАШЕ ИМЯ:</label>
            <input type="text" id="name-input" required autocomplete="off" placeholder="Имя...">
          </div>
          <button type="submit" id="submit-button">
            <span class="button-text">ВЗЯТЬ ТАЛОН</span>
            <div class="loader" id="submit-loader"></div>
          </button>
          <div id="form-error" class="error-message"></div>
        </form>
      </div>

      <div id="talon-container" class="hidden">
        <div class="talon">
          <div class="talon-header">
            <span class="talon-chip"></span>
            <span class="talon-title">ТАЛОН</span>
          </div>
          <div class="talon-body">
            <span class="талон-label">Имя:</span>
            <span id="talon-name"></span>
            <span class="talon-label">Номер в очереди:</span>
            <span id="talon-number" class="talon-number-large"></span>
          </div>
          <div class="talon-footer">Вы в очереди</div>
        </div>
        <button id="delete-button" class="button-secondary button-danger">Выйти из очереди</button>
        <button id="skip-button" class="button-secondary">Пропустить 1 человека</button>
      </div>
    </section>
  </main>

  <!-- библиотеки -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <!-- логика расписания (только из schedule.json) -->
  <script>
const FALLBACK_RULES = { timeZone:'Europe/Moscow', windows:[{days:[6],start:'13:20',end:'15:30'}], message:'Сейчас не время :)' };
let __LAST_OPEN__ = false;
let __countdownInterval = null;
let __boundaryTimeout   = null;

function parseHM(hm){ const [h,m]=hm.split(':').map(Number); return h*60+m; }
function getZonedNowParts(tz) {
  const d = new Date();
  const dowFmt = new Intl.DateTimeFormat('en-US', { timeZone: tz==='local'?undefined:tz, weekday:'short' });
  const hmFmt  = new Intl.DateTimeFormat('ru-RU', { timeZone: tz==='local'?undefined:tz, hour:'2-digit', minute:'2-digit', hourCycle:'h23' });
  const dowStr = dowFmt.format(d);
  const parts  = hmFmt.formatToParts(d).reduce((a,p)=>{a[p.type]=p.value;return a;}, {});
  const dowMap = {Sun:0, Mon:1, Tue:2, Wed:3, Thu:4, Fri:5, Sat:6};
  const hours = parseInt(parts.hour,10), minutes = parseInt(parts.minute,10);
  return { dow: dowMap[dowStr], minutesFromMidnight: hours*60+minutes };
}
function isOpenNow(rules){
  const now = getZonedNowParts(rules.timeZone);
  return rules.windows.some(w => w.days.includes(now.dow) &&
    now.minutesFromMidnight >= parseHM(w.start) &&
    now.minutesFromMidnight <  parseHM(w.end));
}
function renderSchedule(rules){
  const mapDay=['Вс','Пн','Вт','Ср','Чт','Пт','Сб'];
  const text = rules.windows.map(w=>`${w.days.map(d=>mapDay[d]).join(', ')} — ${w.start}–${w.end}`).join(' | ');
  const el = document.getElementById('closed-schedule');
  if (el) el.textContent = text ? `График: ${text}` : '';
}
function msUntilNextBoundary(rules){
  const { timeZone, windows } = rules;
  const now = new Date();
  const fmtDOW = new Intl.DateTimeFormat('en-US', { timeZone: timeZone==='local'?undefined:timeZone, weekday:'short' });
  const dowMap = {Sun:0, Mon:1, Tue:2, Wed:3, Thu:4, Fri:5, Sat:6};
  const dow = dowMap[fmtDOW.format(now)];
  function dateAt(dayOffset, mfm){
    const base = new Date(now.getTime()+dayOffset*86400000);
    const y = new Intl.DateTimeFormat('en-CA',{ timeZone: timeZone==='local'?undefined:timeZone, year:'numeric'}).format(base);
    const m = new Intl.DateTimeFormat('en-CA',{ timeZone: timeZone==='local'?undefined:timeZone, month:'2-digit'}).format(base);
    const d = new Intl.DateTimeFormat('en-CA',{ timeZone: timeZone==='local'?undefined:timeZone, day:'2-digit'}).format(base);
    const hh=String(Math.floor(mfm/60)).padStart(2,'0');
    const mm=String(mfm%60).padStart(2,'0');
    return new Date(`${y}-${m}-${d}T${hh}:${mm}:00`);
  }
  const candidates=[];
  for(let dOff=0; dOff<8; dOff++){
    const thisDow = (dow+dOff)%7;
    const todays = windows.filter(w=>w.days.includes(thisDow));
    for(const w of todays){
      const s=parseHM(w.start), e=parseHM(w.end);
      const sDate=dateAt(dOff,s), eDate=dateAt(dOff,e);
      if(sDate>now) candidates.push(+sDate);
      if(eDate>now) candidates.push(+eDate);
    }
  }
  if(!candidates.length) return {ms:null,ts:null};
  const nextTs=Math.min(...candidates);
  return {ms: nextTs-+now, ts: nextTs};
}
function formatDuration(ms){
  if(ms<0) ms=0;
  const totalSec=Math.floor(ms/1000);
  const h=Math.floor(totalSec/3600);
  const m=Math.floor((totalSec%3600)/60);
  const s=totalSec%60;
  const pad=n=>String(n).padStart(2,'0');
  return h>0?`${h}:${pad(m)}:${pad(s)}`:`${m}:${pad(s)}`;
}
function clearBoundaryTimers(){ if(__countdownInterval){clearInterval(__countdownInterval);__countdownInterval=null;} if(__boundaryTimeout){clearTimeout(__boundaryTimeout);__boundaryTimeout=null;} }
function planBoundaryAndMaybeCountdown(rules){
  clearBoundaryTimers();
  const { ms } = msUntilNextBoundary(rules);
  if(ms==null) return;
  const el = document.getElementById('reopen-countdown');
  if(!window.__SITE_OPEN__ && el){
    let remain=ms;
    el.textContent = `Откроется через: ${formatDuration(remain)}`;
    __countdownInterval=setInterval(()=>{
      remain-=1000;
      if(remain<=0){ clearBoundaryTimers(); el.textContent='Открываем...'; }
      else { el.textContent=`Откроется через: ${formatDuration(remain)}`; }
    },1000);
  }
  const BUFFER_MS=1000;
  __boundaryTimeout=setTimeout(()=>{ fetchRemoteRules().then(r=>r&&applyRulesAndReact(r)); }, Math.max(0, ms+BUFFER_MS));
}

const SCHEDULE_URL='schedule.json';
async function fetchRemoteRules(){
  try{
    const res=await fetch(SCHEDULE_URL+'?t='+Date.now(),{cache:'no-store',headers:{'Cache-Control':'no-store'}});
    if(!res.ok) return null;
    return await res.json();
  }catch{ return null; }
}

/* === ИСПРАВЛЕНАЯ ФУНКЦИЯ === */
function applyRulesAndReact(remoteRules){
  if(!remoteRules) return;

  const nowOpen = isOpenNow(remoteRules);

  const overlay  = document.getElementById('closed-overlay');
  const container = document.querySelector('.container');
  const title    = overlay?.querySelector('.closed-title');

  // Всегда актуализируем DOM-состояние
  if (nowOpen) {
    overlay?.classList.remove('active');
    container?.classList.remove('hidden');
    container?.removeAttribute('inert');
    container?.style.removeProperty('display');   // снять inline display:none
  } else {
    overlay?.classList.add('active');
    container?.classList.add('hidden');
    container?.setAttribute('inert','');
    container?.style.setProperty('display','none');
    if (title && remoteRules.message) title.textContent = remoteRules.message;
  }

  // Флаги обновляем при изменении
  if (nowOpen !== __LAST_OPEN__) {
    window.__SITE_OPEN__  = nowOpen;
    window.__BLOCK_INIT__ = !nowOpen;
  }

  // Если открыто и приложение ещё не стартовало — запускаем
  if (nowOpen && !window.__APP_STARTED__ && typeof window.startQueueApp === 'function') {
    try { window.startQueueApp(); } catch(e){ console.error(e); }
  }

  renderSchedule(remoteRules);
  planBoundaryAndMaybeCountdown(remoteRules);

  __LAST_OPEN__ = nowOpen;

  const boot = document.getElementById('boot-style');
  if (boot) boot.remove();
}
/* === /ИСПРАВЛЕНАЯ ФУНКЦИЯ === */

document.addEventListener('DOMContentLoaded', ()=>{
  const overlay=document.getElementById('closed-overlay');
  const container=document.querySelector('.container');
  overlay?.classList.add('active');
  container?.classList.add('hidden');
  container?.setAttribute('inert','');
  renderSchedule(FALLBACK_RULES);

  (async function startWatcher(pollMs=5000){
    const first=await fetchRemoteRules(); if(first) applyRulesAndReact(first);
    setInterval(async()=>{ const remote=await fetchRemoteRules(); if(remote) applyRulesAndReact(remote); }, pollMs);
  })();
});
  </script>

  <!-- приложение (старт через window.startQueueApp()) -->
  <script>
(function(){
  'use strict';

  // запуск только когда открыто
  window.startQueueApp = function startQueueApp(){
    if(window.__APP_STARTED__) return;
    window.__APP_STARTED__ = true;

    const firebaseConfig = {
      apiKey: "AIzaSyBv6hJVtMFETIRW-QUVRSKh73bmm9b4zEM",
      authDomain: "talony-fd34c.firebaseapp.com",
      projectId: "talony-fd34c",
      storageBucket: "talony-fd34c.firebasestorage.app",
      messagingSenderId: "806366155366",
      appId: "1:806366155366:web:c8ce518f0be3561bd6d3a7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const queueCollection = db.collection('queue');

    const STORAGE_KEY_ID = 'myQueueTalonId';
    const STORAGE_KEY_NAME = 'myQueueTalonName';
    const STORAGE_KEY_LAST_CLEANUP = 'myQueueLastCleanup';

    let currentUserTalonId = null;
    const dom = {};

    const UI = {
      renderQueue: (queueData) => {
        dom.queueList.innerHTML = '';
        if (queueData.length === 0) dom.emptyMessage.classList.remove('hidden');
        else dom.emptyMessage.classList.add('hidden');

        /* --- добавлено: сохраняем локальный отсортированный список --- */
        dom.__lastQueue = queueData.map(x => ({ id: x.id, orderKey: x.orderKey }));
        /* -------------------------------------------------------------- */

        const fragment = document.createDocumentFragment();
        let userNumberInQueue = null;
        let userTalonStillExists = false;

        queueData.forEach((item, index) => {
          if (item.id === currentUserTalonId) { userNumberInQueue = index + 1; userTalonStillExists = true; }
          const li = document.createElement('li');
          const numberSpan = document.createElement('span');
          numberSpan.className = 'queue-number';
          numberSpan.textContent = `#${index + 1}`;
          const nameSpan = document.createElement('span');
          nameSpan.className = 'queue-name';
          nameSpan.textContent = item.name;
          const timeSpan = document.createElement('span');
          timeSpan.className = 'queue-time';
          if (item.timestamp) {
            const date = item.timestamp.toDate();
            timeSpan.textContent = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
          }
          li.appendChild(numberSpan);
          li.appendChild(nameSpan);
          li.appendChild(timeSpan);
          fragment.appendChild(li);
        });
        dom.queueList.appendChild(fragment);

        if (currentUserTalonId && !userTalonStillExists) UI.resetForm();
        else if (userNumberInQueue) UI.updateTalonNumber(userNumberInQueue);
      },
      updateTalonNumber: (number) => { if (dom.talonNumber) dom.talonNumber.textContent = `#${number}`; },
      showQueueLoading: (isLoading) => { dom.queueLoader.classList.toggle('active', isLoading); },
      setFormLoading: (isLoading) => {
        dom.submitButton.disabled = isLoading;
        dom.nameInput.disabled = isLoading;
        dom.buttonText.textContent = isLoading ? 'РЕГИСТРАЦИЯ...' : 'ВЗЯТЬ ТАЛОН';
      },
      setTalonLoading: (isLoading) => {
        if (dom.deleteButton) {
          dom.deleteButton.disabled = isLoading;
          dom.deleteButton.textContent = isLoading ? 'ВЫХОДИМ...' : 'Выйти из очереди';
        }
      },
      showFormError: (message) => {
        dom.formError.textContent = message;
        dom.formError.style.display = message ? 'block' : 'none';
      },
      showTalon: (name, docId) => {
        currentUserTalonId = docId;
        dom.talonName.textContent = name;
        dom.talonNumber.textContent = '#...';
        dom.formContainer.classList.add('hidden');
        dom.talonContainer.classList.remove('hidden');
      },
      resetForm: () => {
        currentUserTalonId = null;
        localStorage.removeItem(STORAGE_KEY_ID);
        localStorage.removeItem(STORAGE_KEY_NAME);
        dom.formContainer.classList.remove('hidden');
        dom.talonContainer.classList.add('hidden');
        dom.nameInput.value = '';
        UI.showFormError(null);
      }
    };

    const API = {
      // === ИЗМЕНЕНО: сортировка по orderKey ===
      listenForQueueChanges: () => {
        UI.showQueueLoading(true);
        queueCollection.orderBy('orderKey', 'asc').onSnapshot(
          (snapshot) => {
            const queueData = [];
            snapshot.forEach((doc) => queueData.push({ id: doc.id, ...doc.data() }));
            UI.renderQueue(queueData);
            UI.showQueueLoading(false);
          },
          (error) => {
            console.error('Ошибка real-time подписки:', error);
            UI.showFormError('Ошибка: не могу обновить очередь.');
            UI.showQueueLoading(false);
          }
        );
      },

      // === ИЗМЕНЕНО: при добавлении пишем orderKey ===
      addTalon: async (name) => {
        UI.setFormLoading(true);
        UI.showFormError(null);
        try {
          const orderKey = Date.now() * 1000 + Math.floor(Math.random() * 1000);
          const docRef = await queueCollection.add({
            name,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            orderKey
          });
          localStorage.setItem(STORAGE_KEY_ID, docRef.id);
          localStorage.setItem(STORAGE_KEY_NAME, name);
          UI.showTalon(name, docRef.id);
        } catch (error) {
          console.error('Ошибка при добавлении талона:', error);
          UI.showFormError(`Ошибка: ${error.message}`);
        } finally { UI.setFormLoading(false); }
      },

      deleteTalon: async () => {
        if (!currentUserTalonId) return;
        UI.setTalonLoading(true); UI.showFormError(null);
        try {
          await queueCollection.doc(currentUserTalonId).delete();
          UI.resetForm();
        } catch (error) {
          console.error('Ошибка при удалении талона:', error);
          UI.showFormError(`Ошибка: ${error.message}`);
        } finally { UI.setTalonLoading(false); }
      },

      deleteOldTalons: async () => {
        try {
          const fiveHoursAgo = firebase.firestore.Timestamp.fromMillis(Date.now() - 5*60*60*1000);
          const snapshot = await queueCollection.where('timestamp','<',fiveHoursAgo).get();
          if (snapshot.empty) return;
          const batch = db.batch();
          snapshot.forEach(doc=>batch.delete(doc.ref));
          await batch.commit();
        } catch (error) {
          console.error('Ошибка во время чистки:', error);
        }
      }
    };

    const Handlers = {
      handleFormSubmit: (event) => {
        event.preventDefault();
        const name = dom.nameInput.value.trim();
        if (name.length < 2) return UI.showFormError('Имя должно содержать хотя бы 2 символа.');
        if (name.length > 50) return UI.showFormError('Имя слишком длинное (макс. 50 символов).');
        API.addTalon(name);
      },

      handleDeleteClick: () => API.deleteTalon(),

      // === ПРОПУСТИТЬ РОВНО 1: без лишнего запроса, свап по локальному списку ===
      handleSkipClick: async () => {
        if (!currentUserTalonId) return;

        // Берём уже отрисованный локальный список (он отсортирован по orderKey)
        const q = Array.isArray(dom.__lastQueue) ? dom.__lastQueue : [];
        const myIdx = q.findIndex(it => it.id === currentUserTalonId);
        if (myIdx === -1) {
          UI.showFormError('Не нашли ваш талон в очереди. Обновите страницу.');
          setTimeout(()=>UI.showFormError(''), 1800);
          return;
        }
        if (myIdx === q.length - 1) {
          UI.showFormError('Вы уже последний в очереди.');
          setTimeout(()=>UI.showFormError(''), 1500);
          return;
        }

        const nextId = q[myIdx + 1]?.id;
        if (!nextId) return;

        const userRef = queueCollection.doc(currentUserTalonId);
        const nextRef = queueCollection.doc(nextId);

        // Оптимистичная обратная связь на кнопке
        const oldSkipText = dom.skipButton?.textContent;
        if (dom.skipButton) {
          dom.skipButton.disabled = true;
          dom.skipButton.textContent = 'Пропускаем…';
        }

        try {
          // Транзакция: читаем РОВНО два документа и меняем их orderKey местами
          await firebase.firestore().runTransaction(async (tx) => {
            const [uS, nS] = await Promise.all([tx.get(userRef), tx.get(nextRef)]);
            if (!uS.exists || !nS.exists) throw new Error('Очередь обновляется, попробуйте ещё раз.');

            const a = uS.get('orderKey');
            const b = nS.get('orderKey');
            if (typeof a !== 'number' || typeof b !== 'number') {
              throw new Error('Подождите, данные ещё сохраняются…');
            }

            // атомарный свап
            tx.update(userRef, { orderKey: b });
            tx.update(nextRef, { orderKey: a });
          });

        } catch (err) {
          console.error(err);
          UI.showFormError(err.message || 'Не удалось пропустить. Попробуйте ещё раз.');
          setTimeout(()=>UI.showFormError(''), 2000);
        } finally {
          if (dom.skipButton) {
            dom.skipButton.disabled = false;
            dom.skipButton.textContent = oldSkipText || 'Пропустить 1 человека';
          }
        }
      }
    };

    // --- НОВОЕ: разовая инициализация orderKey для старых документов ---
    async function ensureOrderKeysForOldDocs() {
      try {
        const snap = await queueCollection.orderBy('timestamp', 'asc').limit(200).get();
        const batch = db.batch();
        let changed = 0;
        snap.forEach((doc, i) => {
          const data = doc.data() || {};
          if (typeof data.orderKey !== 'number') {
            const ts = data.timestamp && data.timestamp.toMillis ? data.timestamp.toMillis() : Date.now();
            const orderKey = ts * 1000 + i; // стабильный порядок по старому времени
            batch.update(doc.ref, { orderKey });
            changed++;
          }
        });
        if (changed > 0) { await batch.commit(); }
      } catch (e) {
        console.warn('Не удалось проинициализировать orderKey для старых документов:', e);
      }
    }
    // -------------------------------------------------------------------

    function cacheDomElements(){
      dom.queueList = document.getElementById('queue-list');
      dom.queueLoader = document.getElementById('queue-loader');
      dom.emptyMessage = document.getElementById('empty-queue-message');
      dom.formPanel = document.getElementById('form-panel');
      dom.formContainer = document.getElementById('form-container');
      dom.talonForm = document.getElementById('talon-form');
      dom.nameInput = document.getElementById('name-input');
      dom.submitButton = document.getElementById('submit-button');
      dom.buttonText = document.querySelector('#submit-button .button-text');
      dom.formError = document.getElementById('form-error');
      dom.talonContainer = document.getElementById('talon-container');
      dom.talonName = document.getElementById('talon-name');
      dom.talonNumber = document.getElementById('talon-number');
      dom.deleteButton = document.getElementById('delete-button');
      dom.skipButton = document.getElementById('skip-button');
    }

    function init(){
      cacheDomElements();
      if (dom.talonForm) dom.talonForm.addEventListener('submit', Handlers.handleFormSubmit);
      if (dom.deleteButton) dom.deleteButton.addEventListener('click', Handlers.handleDeleteClick);
      if (dom.skipButton) dom.skipButton.addEventListener('click', Handlers.handleSkipClick);
      API.listenForQueueChanges();

      // разово заполним orderKey для старых записей (если есть)
      ensureOrderKeysForOldDocs();

      const id = localStorage.getItem(STORAGE_KEY_ID);
      const name = localStorage.getItem(STORAGE_KEY_NAME);
      if (id && name) UI.showTalon(name, id);

      const hour = 60*60*1000;
      const lastCleanup = localStorage.getItem(STORAGE_KEY_LAST_CLEANUP);
      const now = Date.now();
      if (!lastCleanup || (now - new Date(lastCleanup).getTime()) > hour) {
        API.deleteOldTalons().then(() => {
          localStorage.setItem(STORAGE_KEY_LAST_CLEANUP, new Date().toISOString());
        });
      }
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();
  };

  // если к моменту исполнения уже открыто — стартуем сразу
  if (!window.__BLOCK_INIT__) window.startQueueApp();
})();
  </script>
</body>
</html>
